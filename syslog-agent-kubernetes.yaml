###########
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: syslog-agent-log-dest
  namespace: default
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: local-path

#####################

apiVersion: v1
kind: ConfigMap
metadata:
  name: syslog-agent-config
  namespace: default
data:
  syslog-ng.conf: |
    @version: 3.26
    
    source s_dir { wildcard-file(
        base-dir("/var/log/containers")
        filename-pattern("*.log")
        max-files(1500)
        follow-freq(0.5)
        monitor-method(poll)
        log-fetch-limit(100)
        log-iw-size(15000)
        flags(no-parse)
        recursive(yes)
        multi-line-mode(indented)
    ); };
    
    destination d_file {
        file("/var/result/test");
    };
      
    log {
        source(s_dir); destination(d_file);
    };


###########
apiVersion: v1
kind: Pod
metadata:
  name: syslog-agent
  namespace: default
spec:
  nodeSelector:
    kubernetes.io/hostname: kube-node-1
  containers:
  - image: syslog-ng:test
    name: syslog-agent
    command: ["/bin/sh","-c"]
    args: ["/bin/syslog_ng_exporter --telemetry.address=":9577" --log.format="logger:stderr?appname=syslog-agent" --socket.path="/var/lib/syslog-ng/syslog-ng.ctl" & /usr/sbin/syslog-ng -F"]
    volumeMounts:
    - mountPath: /var/log
      name: varlog
    - mountPath: /etc/syslog-ng
      name: syslog-ng-config
    - mountPath: /var/result
      name: logs-dest
    - name: varlibdockercontainers
      mountPath: /var/lib/docker/containers
      readOnly: true
  volumes:
  - hostPath:
      path: /var/lib/docker/containers
      type: ""
    name: varlibdockercontainers
  - name: varlog
    hostPath:
      path: /var/log
  - name: logs-dest
    persistentVolumeClaim:
      claimName: syslog-agent-log-dest
  - configMap:
      defaultMode: 420
      name: syslog-agent-config
    name: syslog-ng-config
  nodeSelector:
    kubernetes.io/hostname: kube-node-1
  securityContext:
    fsGroup: 0
    runAsGroup: 0
    runAsUser: 0
